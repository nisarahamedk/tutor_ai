# Architecture Document: Intelligent Tutoring System (ITS)

## 1. Overview

This document outlines the architecture for the Intelligent Tutoring System (ITS), an AI-driven platform designed to provide personalized and adaptive learning experiences. The system features a chat-first interface, leveraging AI agents and rich interactive components to deliver engaging and effective tutoring.

## 2. Architectural Principles

*   **Chat-First:** All user interactions are centered around a conversational interface.
*   **Agent-Driven:** AI agents orchestrate the learning experience, from assessment to content delivery.
*   **Rich Interactivity:** Modern UI components are used within the chat to minimize typing and maximize engagement.
*   **Adaptability:** The system personalizes learning paths and content based on individual user needs and progress.
*   **Scalability and Maintainability:** The architecture is designed to be scalable and easy to maintain.
*   **Modularity:** Components are designed to be loosely coupled, allowing for independent development and updates.

## 3. System Components

The ITS is composed of the following main components:

*   **Frontend:** User-facing application responsible for rendering the chat interface and interactive components.
*   **Backend:** Server-side application that handles business logic, data processing, and communication with AI agents and other services.
*   **AI Agents:** Core intelligence of the system, responsible for understanding user input, making decisions, and interacting with LLMs.
*   **Temporal.io Cluster:** Workflow orchestration engine for managing long-running processes, particularly chat conversations and learning paths.

### 3.1. Frontend

*   **Framework:** Next.js (React)
*   **Key Libraries/Technologies:**
    *   **AG-UI Client:** Communication with the backend is managed by `frontend/src/lib/ag-ui-client.ts` (for core setup) and feature-specific services like `frontend/src/features/ai-tutor/services/agUiService.ts`. These handle AG-UI event subscriptions, message sending, and state updates for a seamless interactive experience.
    *   **UI Components:** `shadcn/ui` (expected to be in `frontend/src/components/ui/` as per the structure) will be used for building the user interface, complemented by custom components in `frontend/src/components/common/` and feature-specific components (e.g., `frontend/src/features/ai-tutor/components/`).
    *   **Rich Component Library:** A set of custom React components designed for the chat interface (e.g., interactive cards, sliders, code editors, visual diagrams) will be developed and organized within `frontend/src/features/ai-tutor/components/` or a shared library.
*   **Responsibilities:**
    *   Render the main chat dashboard (e.g., using `frontend/src/features/ai-tutor/index.tsx` within the Next.js `app/` structure).
    *   Display rich components as instructed by the AI agents.
    *   Capture user input through text and interactive components.
    *   Send user actions and events to the backend via AG-UI.
    *   Receive and display real-time updates and messages from the backend/AI agents.

### 3.2. Backend

*   **Framework:** Python FastAPI
*   **Key Libraries/Technologies:**
    *   **AG-UI Server Endpoint:** The primary interface for AG-UI communication from the frontend will be `backend/app/api/v1/endpoints/chat.py`. This endpoint will handle incoming WebSocket connections, receive messages, and emit AG-UI events generated by AI agents or Temporal processes.
    *   **Temporal.io SDK:** The `backend/app/temporal/` directory will house workflow (`workflows.py`) and activity (`activities.py`) definitions. The `client.py` in this directory will manage the Temporal client for communication with the cluster.
    *   **Supabase Client:** Database interactions via Supabase will be managed within `backend/app/db/`. This includes client initialization (`database.py`), data models (`models.py`), and CRUD operations (`crud.py`).
    *   **AI Agent Frameworks (e.g., LangGraph, CrewAI):** These will be integrated within the `backend/app/agents/` directory (e.g., `tutor_agent.py`, `a2a_agents.py`).
*   **Responsibilities:**
    *   Expose API endpoints (e.g., `chat.py` for AG-UI, `health.py` for health checks, as defined in `backend/app/api/v1/endpoints/`).
    *   Authenticate and authorize users (leveraging Supabase via `backend/app/db/` and potentially dedicated services in `backend/app/services/`).
    *   Manage user sessions and state, potentially distributed between Supabase and Temporal workflows.
    *   Interface with AI agents (defined in `backend/app/agents/`) to process user input and generate responses.
    *   Initiate and manage Temporal workflows (defined in `backend/app/temporal/workflows.py`) for each chat session and learning path.
    *   Store and retrieve data from Supabase (via `backend/app/db/`).

### 3.3. AI Agents

*   **Frameworks (Potential):** LangGraph, CrewAI (integrated via AG-UI)
*   **Key Libraries/Technologies:**
    *   **LLM SDKs (e.g., OpenAI API, Hugging Face Transformers):** For interacting with Large Language Models.
    *   **AG-UI Integration:** To receive user input from the backend and send instructions/content back.
*   **Responsibilities:**
    *   Process and understand natural language input from users.
    *   Determine user intent and context.
    *   Make decisions on how to guide the learning process (e.g., which topic to present, what type of assessment to use).
    *   Select and configure appropriate rich components for the frontend to display.
    *   Generate personalized content and feedback.
    *   Interact with LLMs for complex reasoning, content generation, and conversational abilities.
    *   Manage the state of the learning interaction within a Temporal workflow.

### 3.4. Temporal.io Cluster

*   **Responsibilities:**
    *   Orchestrate long-running, stateful chat conversations. Each active user chat session can be modeled as a workflow instance.
    *   Manage complex learning paths that may involve multiple steps, conditions, and interactions with AI agents.
    *   Ensure reliability and fault tolerance for critical user interactions.
    *   Handle asynchronous tasks and timers related to the learning process (e.g., reminders, scheduled content).

### 3.5. Detailed Project Structure

This section outlines the proposed file and directory structure for the frontend and backend components of the ITS.

#### 3.5.1. Frontend (Next.js/React)

```
frontend/
├── public/                     # Static assets
├── src/
│   ├── app/                    # Next.js App Router (layout, pages)
│   │   ├── layout.tsx
│   │   └── page.tsx
│   ├── assets/                 # Images, fonts, etc.
│   ├── components/
│   │   ├── ui/                 # UI components (e.g., from shadcn/ui)
│   │   └── common/             # Common shared components
│   ├── features/
│   │   └── ai-tutor/           # Feature-specific module for the AI Tutor
│   │       ├── components/     # Components specific to the AI Tutor chat interface
│   │       ├── hooks/          # React hooks (e.g., useAITutorChat.ts for chat logic)
│   │       ├── types/          # TypeScript types (e.g., Message, LearningTrack)
│   │       ├── services/       # Services (e.g., agUiService.ts for AG-UI client logic)
│   │       └── index.tsx       # Main component for the AI Tutor feature (e.g., AITutorChat)
│   ├── lib/
│   │   ├── utils.ts            # Utility functions (e.g., cn for Tailwind)
│   │   └── ag-ui-client.ts     # AG-UI client setup and core communication logic
│   ├── styles/                 # Global styles
│   └── ...                     # Other directories as needed
├── .env.local                  # Local environment variables
├── next.config.js              # Next.js configuration
├── postcss.config.js           # PostCSS configuration
├── tailwind.config.ts          # Tailwind CSS configuration
├── components.json             # shadcn/ui configuration
├── tsconfig.json               # TypeScript configuration
└── package.json                # Project dependencies and scripts
```

#### 3.5.2. Backend (Python/FastAPI)

```
backend/
├── app/
│   ├── api/
│   │   └── v1/
│   │       └── endpoints/
│   │           ├── chat.py     # AG-UI WebSocket endpoint for chat
│   │           └── health.py   # Health check endpoint
│   ├── core/                   # Core application settings (config.py, logging.py)
│   ├── db/                     # Database interaction logic
│   │   ├── database.py         # Supabase client initialization and session
│   │   ├── models.py           # Database models (e.g., Pydantic or SQLAlchemy)
│   │   └── crud.py             # CRUD operations for database models
│   ├── agents/                 # AI agent implementations
│   │   ├── tutor_agent.py      # Main tutoring agent logic
│   │   ├── mcp_tools.py        # Tools/capabilities for agents (e.g., RAG, code execution)
│   │   └── a2a_agents.py       # Supporting agents if using a multi-agent setup
│   ├── temporal/               # Temporal.io workflow and activity definitions
│   │   ├── workflows.py        # Temporal workflow definitions (e.g., ChatWorkflow, LearningPathWorkflow)
│   │   ├── activities.py       # Temporal activity definitions (e.g., call_ai_agent, update_db)
│   │   └── client.py           # Temporal client initialization
│   ├── services/               # Business logic services (e.g., chat_service.py, user_service.py)
│   ├── main.py                 # FastAPI application entry point
│   └── __init__.py
├── tests/                      # Unit and integration tests
├── .env                        # Environment variables
├── Dockerfile                  # Docker configuration for the backend
├── poetry.lock                 # Poetry lock file
├── pyproject.toml              # Python project configuration (Poetry)
└── README.md
```

## 4. Data Flow and Communication

1.  **User Interaction:** The user interacts with the Next.js/React frontend, specifically components within `frontend/src/features/ai-tutor/` (e.g., the main `AITutorChat` component likely in `index.tsx`).
2.  **Frontend to Backend (AG-UI):** User actions (text input, interactions with rich components) are captured, potentially by hooks like `frontend/src/features/ai-tutor/hooks/useAITutorChat.ts`. These actions are then sent to the backend using the AG-UI client. The `frontend/src/features/ai-tutor/services/agUiService.ts` would handle feature-specific AG-UI logic, leveraging the core client setup in `frontend/src/lib/ag-ui-client.ts` for WebSocket/SSE connection and event formatting.
3.  **Backend AG-UI Endpoint:** The FastAPI backend receives the AG-UI event at the WebSocket endpoint defined in `backend/app/api/v1/endpoints/chat.py`.
4.  **Backend Processing & Temporal Workflow Initiation/Signaling:**
    *   The `chat.py` endpoint, likely with the help of a service (e.g., `backend/app/services/chat_service.py`), processes the incoming message.
    *   It may interact with Supabase via modules in `backend/app/db/` (e.g., using `crud.py`) for immediate data storage or retrieval (like saving the user's message or fetching user context).
    *   It then signals the relevant Temporal workflow instance (e.g., `ChatWorkflow` defined in `backend/app/temporal/workflows.py`) associated with the user's chat session, passing along the user input and any necessary context. If a workflow isn't active, it might start one.
5.  **Temporal Workflow Execution:**
    *   The Temporal workflow (e.g., `ChatWorkflow`) executes its defined logic. This workflow manages the state of the conversation or learning path over potentially long durations.
    *   Activities defined in `backend/app/temporal/activities.py` are invoked by the workflow. These activities perform the actual work, such as:
        *   Calling AI Agents.
        *   Updating the database (Supabase, via `backend/app/db/` functions).
        *   Performing other long-running tasks or interacting with external services.
6.  **AI Agent Interaction:**
    *   A Temporal activity calls an AI Agent (e.g., `tutor_agent.py` located in `backend/app/agents/`).
    *   The AI Agent processes the input. This may involve interacting with an LLM (via SDKs), utilizing tools or capabilities defined in `backend/app/agents/mcp_tools.py` (like RAG or code execution), and determining the next steps (e.g., content to send back, rich components to display, or questions to ask).
    *   The agent returns its response or decision to the Temporal activity.
7.  **Temporal Workflow to Backend AG-UI:** The Temporal workflow, upon receiving results from its activities (e.g., an AI agent's response or data from the database), needs to send this information back to the user. It can do this by signaling the main FastAPI application or by using a dedicated activity that has access to the AG-UI sender/broadcaster associated with the user's session in `chat.py`.
8.  **Backend to Frontend (AG-UI):** The FastAPI backend (specifically `chat.py`, possibly triggered by a signal from a Temporal workflow or an activity) sends events/messages back to the connected Next.js/React frontend via the established AG-UI WebSocket/SSE connection. These messages might include new text from the AI, instructions to render specific rich components with particular data, or other state updates.
9.  **UI Update:** The Next.js/React frontend's AG-UI client (`ag-ui-client.ts` and `agUiService.ts`) receives these events. Hooks like `useAITutorChat.ts` process these events, updating the application state, which in turn causes the React components (e.g., `AITutorChat` and its children) to re-render, displaying new messages, interactive elements, or reflecting other state changes.

## 5. Architecture Diagram

```mermaid
graph TD
    User[User] --> FE[Next.js Frontend (AG-UI Client: agUiService.ts)]
    FE -->|AG-UI (Events, Actions)| BE[FastAPI Backend (AG-UI Endpoint: chat.py)]
    BE -->|Workflow Commands| Temporal[Temporal.io Cluster]
    Temporal -->|Activity Tasks| AIAgents[AI Agents / LLM Interactions]
    AIAgents -->|Results| Temporal
    Temporal -->|Workflow Updates| BE
    BE -->|AG-UI (Events, State Updates)| FE
    BE --> SBDB[(Supabase (PostgreSQL))]

    subgraph "Browser"
        FE
    end

    subgraph "Server Infrastructure"
        BE
        Temporal
        AIAgents
        SBDB
    end

    style FE fill:#add,stroke:#333,stroke-width:2px
    style BE fill:#dda,stroke:#333,stroke-width:2px
    style Temporal fill:#dad,stroke:#333,stroke-width:2px
    style AIAgents fill:#ada,stroke:#333,stroke-width:2px
    style SBDB fill:#ddd,stroke:#333,stroke-width:2px
```

## 6. Data Persistence

*   **User Data:** User profiles, authentication details, preferences.
*   **Learning Progress:** Track completion, assessment scores, current position in learning tracks.
*   **Content Cache:** Potentially cache frequently accessed learning materials.
*   **Workflow State:** Temporal.io handles the persistence of workflow state.
*   Supabase (PostgreSQL) is the preferred choice for data persistence. It offers a managed database solution along with built-in features like authentication, real-time capabilities, and storage, which can simplify development and reduce operational overhead.

## 7. Scalability and Deployment

*   **Frontend:** Can be deployed as static assets to a CDN.
*   **Backend (FastAPI):** Containerized (e.g., Docker) and deployed using a scalable hosting solution (e.g., Kubernetes, Serverless Functions).
*   **AI Agents:** Can be deployed as separate microservices (if complex enough) or as part of the main backend container, containerized, and scaled independently or with the backend.
*   **Temporal.io Cluster:** Can be self-hosted or use Temporal Cloud.
*   Load balancers will be used to distribute traffic.
*   Asynchronous task queues (primarily managed by Temporal) will handle background processing.
*   **Local Development:** A `docker-compose.yml` file (expected to be at the repository root or within a `.devcontainer` setup) will be used to orchestrate the local development environment. This would typically include services for the frontend (Next.js), backend (FastAPI), Temporal worker, Temporal server (for local testing, e.g., using the Temporalite image), and Supabase (either a local instance via its Docker image or connection details to a cloud-hosted development instance).
```
